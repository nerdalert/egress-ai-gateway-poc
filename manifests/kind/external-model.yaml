# External model backend: OpenAI-compatible simulator
# __SIM_ADDR__ is replaced at deploy time by setup.sh with the simulator's IP.
#
# This simulates routing to an external model provider (OpenAI, Anthropic, etc.)
# The simulator speaks the OpenAI Chat Completions API over plain HTTP.
apiVersion: ainetworking.prototype.x-k8s.io/v0alpha0
kind: XBackendDestination
metadata:
  name: external-model-backend
  namespace: default
spec:
  destination:
    type: Fqdn
    fqdn:
      hostname: __SIM_ADDR__
    ports:
    - number: 8000
      protocol: HTTP
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: external-model-route
  namespace: default
spec:
  parentRefs:
  - name: poc-gateway
  rules:
  # Route /v1/chat/completions to the external model simulator
  - matches:
    - path:
        type: PathPrefix
        value: "/v1/chat/completions"
    backendRefs:
    - name: external-model-backend
      kind: Backend
      group: ainetworking.prototype.x-k8s.io
      port: 8000
  # Route /v1/models to the external model simulator
  - matches:
    - path:
        type: PathPrefix
        value: "/v1/models"
    backendRefs:
    - name: external-model-backend
      kind: Backend
      group: ainetworking.prototype.x-k8s.io
      port: 8000
  # Route /v1/completions to the external model simulator
  - matches:
    - path:
        type: PathPrefix
        value: "/v1/completions"
    backendRefs:
    - name: external-model-backend
      kind: Backend
      group: ainetworking.prototype.x-k8s.io
      port: 8000
  # Health check passthrough
  - matches:
    - path:
        type: Exact
        value: "/health"
    backendRefs:
    - name: external-model-backend
      kind: Backend
      group: ainetworking.prototype.x-k8s.io
      port: 8000
